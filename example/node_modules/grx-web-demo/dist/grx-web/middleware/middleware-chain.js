"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.middlewares = void 0;
exports.use = use;
exports.next = next;
const handle_1 = require("../server/handle");
const url_normalizer_1 = require("../utils/url-normalizer");
const middlewares = [];
exports.middlewares = middlewares;
function use(middleware) {
    middlewares.push(middleware);
}
async function next(ctx, index = 0) {
    if (index >= middlewares.length) {
        const url = new URL(ctx.req.url || '/', `http://${ctx.req.headers.host}`);
        url.pathname = (0, url_normalizer_1.normalized)(url.pathname);
        console.log("处理开始");
        await (0, handle_1.handler)(ctx, ctx.req, ctx.res, url);
        console.log("处理结束");
        return;
    }
    await middlewares[index](ctx, async () => {
        await next(ctx, index + 1);
    }, ctx.middlewaredData);
}
